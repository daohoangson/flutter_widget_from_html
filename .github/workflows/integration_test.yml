name: Integration test
on:
  push:
    paths:
      - .github/workflows/integration_test.yml
      - "demo_app/**"
      - "packages/fwfh_chewie/**"
      - "packages/fwfh_webview/**"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - name: Setup Flutter
        uses: subosito/flutter-action@fd55f4c5af5b953cc57a2be44cb082c8f6635e8e # v2.21.0
        with:
          cache: true
      - uses: gradle/actions/setup-gradle@4d9f0ba0025fe599b4ebab900eb7f3a1d93ef4c2 # v5.0.0
        with:
          # only update gradle cache from demo_app.yml jobs
          cache-read-only: true
      - run: echo JAVA_HOME=$JAVA_HOME_17_X64 >> $GITHUB_ENV

      - name: Run patrol build
        run: |
          set -e

          dart pub global activate patrol_cli 4.1.0

          cd demo_app
          flutter build apk --config-only
          patrol build android --verbose --target patrol_test/auto_resize_test.dart

      - uses: google-github-actions/auth@7c6bc770dae815cd3e89ee6cdf493a5fab2cc093 # v3.0.0
        with:
          credentials_json: ${{ secrets.FIREBASE_TEST_LAB_CREDENTIALS_JSON }}
      - uses: google-github-actions/setup-gcloud@aa5489c8933f4cc7a4f7d45035b3b1440c9c10db # v3.0.1
      - name: Firebase Test Lab
        run: |
          set -e

          # https://github.com/leancodepl/patrol/blob/1e24994/.github/workflows/test-android-device.yaml#L28
          export ANDROID_DEVICE_MODEL=shiba
          export ANDROID_DEVICE_VERSION=34

          cd demo_app
          gcloud firebase test android run \
            --app build/app/outputs/apk/debug/app-debug.apk \
            --client-details matrixLabel="GitHub #${{ github.run_id }}" \
            --device model="$ANDROID_DEVICE_MODEL",version="$ANDROID_DEVICE_VERSION",locale=en,orientation=portrait \
            --results-bucket=fwfh-dev-patrol-public \
            --test build/app/outputs/apk/androidTest/debug/app-debug-androidTest.apk \
            --timeout 10m \
            --type instrumentation \
            --use-orchestrator

  ios:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - name: Setup Flutter
        uses: subosito/flutter-action@fd55f4c5af5b953cc57a2be44cb082c8f6635e8e # v2.21.0
        with:
          cache: true

      - name: Unlock Fastlane secrets
        env:
          GIT_CRYPT_KEY: ${{ secrets.GIT_CRYPT_KEY }}
        run: |
          set -e

          brew install git-crypt
          echo "${GIT_CRYPT_KEY}" | base64 -d >/tmp/git-crypt-key
          git-crypt unlock /tmp/git-crypt-key
      - name: Run patrol build
        run: |
          set -e

          dart pub global activate patrol_cli 4.1.0

          cd demo_app/ios
          fastlane patrol_build

      - uses: google-github-actions/auth@7c6bc770dae815cd3e89ee6cdf493a5fab2cc093 # v3.0.0
        with:
          credentials_json: ${{ secrets.FIREBASE_TEST_LAB_CREDENTIALS_JSON }}
      - uses: google-github-actions/setup-gcloud@aa5489c8933f4cc7a4f7d45035b3b1440c9c10db # v3.0.1
      - name: Firebase Test Lab
        run: |
          set -e

          # https://github.com/leancodepl/patrol/blob/1e24994/.github/workflows/test-ios-device.yaml#L24
          export IOS_DEVICE_MODEL=iphone14pro
          export IOS_DEVICE_VERSION=16.6

          cd demo_app/build/ios_integ/Build/Products
          zip -r ios_tests.zip Release-iphoneos/*.app *.xctestrun

          gcloud firebase test ios run \
            --client-details matrixLabel="GitHub #${{ github.run_id }}" \
            --device model="$IOS_DEVICE_MODEL",version="$IOS_DEVICE_VERSION",locale=en_US,orientation=portrait \
            --results-bucket=fwfh-dev-patrol-public \
            --test ios_tests.zip \
            --timeout 10m \
            --type xctest
