name: Flutter
on:
  push:
    branches:
      - master
  pull_request:
    branches-ignore:
      - release/beta
      - release/master

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  unit_test:
    name: Unit test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b # v4.1.4
      - uses: actions/dependency-review-action@0c155c5e8556a497adf53f2c18edabf945ed8e70 # v4.3.2
        if: github.base_ref
      - name: Setup Flutter
        uses: subosito/flutter-action@44ac965b96f18d999802d4b807e3256d5a3f9fa1 # v2.16.0
        with:
          cache: true
      - run: dart format --set-exit-if-changed --output none .
      - name: Run chromedriver
        run: |
          set -e

          chromedriver --port=4444 &
          echo CHROMEDRIVER_PORT_4444=yes >$GITHUB_ENV
      - run: ./tool/test.sh --coverage
      - uses: actions/upload-artifact@65462800fd760344b1a7b4382951275a0abb4808 # v4.3.3
        if: failure()
        with:
          name: failures
          path: "**/failures/"
      - uses: codecov/codecov-action@5ecb98a3c6b747ed38dc09f787459979aebb39be # v4.3.1
        with:
          fail_ci_if_error: true
          token: ${{ secrets.CODECOV_TOKEN }}

  integration_test_android:
    name: Integration test (Android)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b # v4.1.4
      - name: Setup Flutter
        uses: subosito/flutter-action@44ac965b96f18d999802d4b807e3256d5a3f9fa1 # v2.16.0
        with:
          cache: true
      - name: Gradle cache
        uses: gradle/gradle-build-action@4c39dd82cd5e1ec7c6fa0173bb41b4b6bb3b86ff # v3.3.2
        with:
          # only update gradle cache from demo_app.yml jobs
          cache-read-only: true
      - run: echo JAVA_HOME=$JAVA_HOME_17_X64 >> $GITHUB_ENV

      - name: Run patrol build
        run: |
          set -e

          dart pub global activate patrol_cli

          cd demo_app
          flutter build apk --config-only
          patrol build android --verbose --target integration_test/auto_resize_test.dart

      - uses: google-github-actions/auth@55bd3a7c6e2ae7cf1877fd1ccb9d54c0503c457c # v2.1.2
        with:
          credentials_json: ${{ secrets.FIREBASE_ADMIN_CREDENTIALS }}
      - uses: google-github-actions/setup-gcloud@98ddc00a17442e89a24bbf282954a3b65ce6d200 # v2.1.0
      - run: gcloud info
      - name: Upload to Firebase
        run: |
          set -e

          cd demo_app
          export ANDROID_DEVICE_MODEL=redfin
          export ANDROID_DEVICE_VERSION=30

          # https://github.com/leancodepl/patrol/blob/master/dev/e2e_app/run_android_testlab
          gcloud firebase test android run \
            --type instrumentation \
            --app build/app/outputs/apk/debug/app-debug.apk \
            --test build/app/outputs/apk/androidTest/debug/app-debug-androidTest.apk \
            --device model="$ANDROID_DEVICE_MODEL",version="$ANDROID_DEVICE_VERSION",locale=en,orientation=portrait \
            --results-bucket=fwfh-dev-patrol-public \
            --timeout 10m \
            --use-orchestrator \
            --environment-variables clearPackageData=true

  integration_test_ios:
    name: Integration test (iOS)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b # v4.1.4
      - name: Setup Flutter
        uses: subosito/flutter-action@44ac965b96f18d999802d4b807e3256d5a3f9fa1 # v2.16.0
        with:
          cache: true

      - name: Unlock Fastlane secrets
        env:
          GIT_CRYPT_KEY: ${{ secrets.GIT_CRYPT_KEY }}
        run: |
          set -e

          brew install git-crypt
          echo "${GIT_CRYPT_KEY}" | base64 -d >/tmp/git-crypt-key
          git-crypt unlock /tmp/git-crypt-key
      - name: Run patrol build
        run: |
          set -e

          dart pub global activate patrol_cli

          cd demo_app/ios
          fastlane patrol_build

      - uses: google-github-actions/auth@55bd3a7c6e2ae7cf1877fd1ccb9d54c0503c457c # v2.1.2
        with:
          credentials_json: ${{ secrets.FIREBASE_ADMIN_CREDENTIALS }}
      - uses: google-github-actions/setup-gcloud@98ddc00a17442e89a24bbf282954a3b65ce6d200 # v2.1.0
      - run: gcloud info
      - name: Upload to Firebase
        run: |
          set -e

          export IOS_DEVICE_MODEL=iphone13pro
          export IOS_DEVICE_VERSION=16.6

          # https://github.com/leancodepl/patrol/blob/master/dev/e2e_app/run_ios_testlab
          cd demo_app/build/ios_integ/Build/Products
          zip -r ios_tests.zip Release-iphoneos/*.app *.xctestrun

          gcloud firebase test ios run \
            --type xctest \
            --test ios_tests.zip \
            --device model="$IOS_DEVICE_MODEL",version="$IOS_DEVICE_VERSION",locale=en_US,orientation=portrait \
            --results-bucket=fwfh-dev-patrol-public \
            --timeout 10m
