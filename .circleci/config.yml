version: 2

defaults: &defaults
  docker:
    - image: cirrusci/flutter
  working_directory: ~/repo

jobs:
  checkout:
    <<: *defaults
    steps:
      - checkout
      - attach_workspace:
          at: ~/repo
      - run: cd packages/core && flutter packages get
      - run: cd packages/example && flutter packages get
      - run: flutter packages get
      - run: curl -s https://codecov.io/bash >codecov.sh && chmod +x codecov.sh
      - persist_to_workspace:
          root: /home/cirrus
          paths:
            - .pub-cache
            - repos
  unit_test_core:
    <<: *defaults
    steps:
      - attach_workspace:
          at: ~/repo
      - run: cd packages/core && flutter test --coverage
      - run: ./codecov.sh -F unit_test_core
  unit_test:
    <<: *defaults
    steps:
      - attach_workspace:
          at: ~/repo
      - run: flutter test --coverage
      - run: ./codecov.sh -F unit_test

workflows:
  version: 2
  workflow:
    jobs:
      - checkout
      - unit_test_core:
          requires:
            - checkout
      - unit_test:
          requires:
            - checkout
