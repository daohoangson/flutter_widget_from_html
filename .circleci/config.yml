version: 2

defaults: &defaults
  docker:
    - image: cirrusci/flutter
  working_directory: ~/repo

jobs:
  checkout:
    <<: *defaults
    steps:
      - checkout
      - attach_workspace:
          at: ~/repo
      - restore_cache:
          keys:
            - pub-cache-{{ .Branch }}-{{ checksum "pubspec.yaml" }}-{{ checksum "packages/core/pubspec.yaml" }}-{{ checksum "packages/example/pubspec.yaml" }}
            - pub-cache-{{ .Branch }}
            - pub-cache
      - run: cd packages/core && flutter packages get
      - run: cd packages/example && flutter packages get
      - run: flutter packages get
      - save_cache:
          key: pub-cache-{{ .Branch }}-{{ checksum "pubspec.yaml" }}-{{ checksum "packages/core/pubspec.yaml" }}-{{ checksum "packages/example/pubspec.yaml" }}
          paths:
            - ~/.pub-cache
      - run: curl -s https://codecov.io/bash >codecov.sh && chmod +x codecov.sh
      - persist_to_workspace:
          root: .
          paths: .
  unit_test_core:
    <<: *defaults
    steps:
      - attach_workspace:
          at: ~/repo
      - restore_cache:
          keys:
            - pub-cache-{{ .Branch }}-{{ checksum "pubspec.yaml" }}-{{ checksum "packages/core/pubspec.yaml" }}-{{ checksum "packages/example/pubspec.yaml" }}
            - pub-cache-{{ .Branch }}
            - pub-cache
      - run: cd packages/core && flutter test --coverage
      - run: ./codecov.sh -F unit_test_core
  unit_test:
    <<: *defaults
    steps:
      - attach_workspace:
          at: ~/repo
      - restore_cache:
          keys:
            - pub-cache-{{ .Branch }}-{{ checksum "pubspec.yaml" }}-{{ checksum "packages/core/pubspec.yaml" }}-{{ checksum "packages/example/pubspec.yaml" }}
            - pub-cache-{{ .Branch }}
            - pub-cache
      - run: flutter test --coverage
      - run: ./codecov.sh -F unit_test
  integration_test:
    macos:
      xcode: '10.2.0'
    steps:
      - checkout
      - run:
          name: setup
          command: |
            brew update
            brew install ideviceinstaller ios-deploy libimobiledevice
            pod repo update
            git clone --single-branch --branch stable https://github.com/flutter/flutter.git
            export PATH=`pwd`/flutter/bin:`pwd`/flutter/bin/cache/dart-sdk/bin:$PATH
            flutter doctor
            xcrun simctl create Flutter-iPhone com.apple.CoreSimulator.SimDeviceType.iPhone-X com.apple.CoreSimulator.SimRuntime.iOS-12-1 | xargs xcrun simctl boot
      - run:
          name: test
          command: |
            export PATH=`pwd`/flutter/bin:`pwd`/flutter/bin/cache/dart-sdk/bin:$PATH
            ./tool/integration.sh

workflows:
  version: 2
  workflow:
    jobs:
      - checkout
      - unit_test_core:
          requires:
            - checkout
      - unit_test:
          requires:
            - checkout
      - integration_test:
          requires:
            - checkout
