version: 2

defaults: &defaults
  docker:
    - image: cirrusci/flutter
  working_directory: ~/repo

jobs:
  checkout:
    <<: *defaults
    steps:
      - checkout
      - attach_workspace:
          at: ~/repo
      - restore_cache:
          keys:
            - pub-cache-{{ .Branch }}-{{ checksum "pubspec.yaml" }}-{{ checksum "packages/core/pubspec.yaml" }}-{{ checksum "packages/example/pubspec.yaml" }}
            - pub-cache-{{ .Branch }}
            - pub-cache
      - run: cd packages/core && flutter packages get
      - run: cd packages/example && flutter packages get
      - run: flutter packages get
      - save_cache:
          key: pub-cache-{{ .Branch }}-{{ checksum "pubspec.yaml" }}-{{ checksum "packages/core/pubspec.yaml" }}-{{ checksum "packages/example/pubspec.yaml" }}
          paths:
            - ~/.pub-cache
      - run: curl -s https://codecov.io/bash >codecov.sh && chmod +x codecov.sh
      - persist_to_workspace:
          root: .
          paths: .
  unit_test_core:
    <<: *defaults
    steps:
      - attach_workspace:
          at: ~/repo
      - restore_cache:
          keys:
            - pub-cache-{{ .Branch }}-{{ checksum "pubspec.yaml" }}-{{ checksum "packages/core/pubspec.yaml" }}-{{ checksum "packages/example/pubspec.yaml" }}
            - pub-cache-{{ .Branch }}
            - pub-cache
      - run: cd packages/core && flutter test --coverage
      - run: ./codecov.sh -F unit_test_core
  unit_test:
    <<: *defaults
    steps:
      - attach_workspace:
          at: ~/repo
      - restore_cache:
          keys:
            - pub-cache-{{ .Branch }}-{{ checksum "pubspec.yaml" }}-{{ checksum "packages/core/pubspec.yaml" }}-{{ checksum "packages/example/pubspec.yaml" }}
            - pub-cache-{{ .Branch }}
            - pub-cache
      - run: flutter test --coverage
      - run: ./codecov.sh -F unit_test
  integration_test:
    <<: *defaults
    steps:
      - attach_workspace:
          at: ~/repo
      - restore_cache:
          keys:
            - pub-cache-{{ .Branch }}-{{ checksum "pubspec.yaml" }}-{{ checksum "packages/core/pubspec.yaml" }}-{{ checksum "packages/example/pubspec.yaml" }}
            - pub-cache-{{ .Branch }}
            - pub-cache
      - run:
          name: setup
          command: |
            _package=$( sdkmanager --list --verbose | grep system-images | grep v7a | grep default | tail -n 1 )
            echo "_package=$package"
            sdkmanager $_package
            echo no | avdmanager create avd -n test -k $_package
      - run:
          name: launch
          command: |
            cd ${ANDROID_HOME}/tools
            export LD_LIBRARY_PATH=${ANDROID_HOME}/emulator/lib64:${ANDROID_HOME}/emulator/lib64/qt/lib
            emulator -avd test -no-window -noaudio -no-boot-anim -no-window -accel on
          background: true
      - run:
          name: wait
          command: |
            curl -s https://raw.githubusercontent.com/nenick/android-circleci-2.0/master/android-wait-for-boot.sh > wait-for-boot.sh
            chmod +x wait-for-boot.sh
            ./wait-for-boot.sh

            # unlock the emulator screen
            sleep 30
            adb shell input keyevent 82
      - run: tool/integration.sh

workflows:
  version: 2
  workflow:
    jobs:
      - checkout
      # - unit_test_core:
      #     requires:
      #       - checkout
      # - unit_test:
      #     requires:
      #       - checkout
      - integration_test:
          requires:
            - checkout
